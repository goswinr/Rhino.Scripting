# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Rhino.Scripting is an F# library that reimplements the RhinoScript API (originally from VBScript/Python) for use in F# and C#. It provides ~900 methods for scripting the Rhino3D CAD application.

## Build Commands

### Development Builds
```bash
# Build the editing version (for development)
dotnet build ForEditing.fsproj

# Build the publishing version (for release)
dotnet build ForPublishing.fsproj --framework net48
dotnet build ForPublishing.fsproj --framework net7.0
```

Note: Build frameworks separately to avoid race conditions in the file combination script.

### Documentation
```bash
# Restore dotnet tools (includes fsdocs-tool)
dotnet tool restore

# Build documentation
# for this to work in dotnet-tools.json, rollForward must be set to 'false' for fsdocs-tool
dotnet fsdocs build --clean --strict --properties Configuration=Release --input Docs --output DocsGenerated
```

### NuGet Package
Building `ForPublishing.fsproj` automatically generates a NuGet package due to `<GeneratePackageOnBuild>true</GeneratePackageOnBuild>`.

## Architecture

### Two-Project Structure

The codebase uses two `.fsproj` files for different purposes:

1. **ForEditing.fsproj** - Development use
   - References individual `Scripting_*.fs` files separately
   - Provides better editor performance
   - Targets only net48
   - Use this when editing source code

2. **ForPublishing.fsproj** - Publishing use
   - Runs `combineIntoOneFile.fsx` before compilation
   - Combines all `Scripting_*.fs` files into one: `AutoGeneratedCode/AllScriptingFilesCombinedIntoOne_DontEditThisFile.fs`
   - Targets both net48 and net7.0
   - Required because F# extension members are not visible in C# - all methods must be in one class in one file
   - Use this for releases

### File Combination System

The build process uses a special marker system:
- `Scripting_Header.fs` contains the class definition start and common imports
- Each `Scripting_*.fs` file contains a split marker `{@$%^&*()*&^%$@}` after which content is merged
- `combineIntoOneFile.fsx` script reads all files and combines them in specific order
- The generated file is deleted after compilation

### Source Organization

Core infrastructure files (always separate):
- `State.fs` - Manages active Rhino document and event handlers
- `RhinoSync.fs` - Thread safety via UI thread marshaling
- `Utils.fs` - General utilities
- `UtilLayer.fs` - Layer-specific utilities
- `UtilString.fs` - String utilities
- `ObjectFilterEnum.fs` - Object type enumeration
- `Exceptions.fs` - Custom exception types
- `Pretty.fs` - Pretty printing support

RhinoScript API implementation files (combined during publishing):
- `Scripting_Header.fs` - Class definition and common code
- `Scripting_Coerce.fs` - Type coercion functions
- `Scripting_Layer.fs` - Layer operations
- `Scripting_Object.fs` - Object manipulation
- `Scripting_Curve.fs` - Curve operations (largest file)
- `Scripting_Surface.fs` - Surface operations
- Plus 15+ more domain-specific files

### Main API Class

All ~900 RhinoScript methods are on a single static class:
```fsharp
[<AbstractClass; Sealed>]
type RhinoScriptSyntax private () =
    static member Doc = State.Doc
    static member Ot = State.Ot
    static member val Sticky = new Dict<string, obj>()
    static member val Filter = new ObjectFilterEnum()
    // ... 900+ methods
```

### Thread Safety

All methods are thread-safe via `RhinoSync`:
- Automatically marshals UI-affecting calls to main Rhino UI thread
- Integrates with Fesh editor if available, falls back to `RhinoApp.MainWindow.Invoke`
- Allows async usage while keeping UI responsive

### Method Overloads

Many methods have multiple overloads to handle:
- Getter/setter duality (same function name for getting and setting)
- Single object vs multiple objects
- Optional parameters (using `[<OPT;DEF(value)>]` attributes)
- Variable input types

Abbreviations used:
- `OPT` = `OptionalAttribute`
- `DEF` = `DefaultParameterValueAttribute`

## Development Guidelines

### Editing Source Code

1. Always edit files in ForEditing.fsproj
2. Never edit `AutoGeneratedCode/AllScriptingFilesCombinedIntoOne_DontEditThisFile.fs` - it's auto-generated
3. When adding methods to `Scripting_*.fs` files, ensure they come after the split marker `{@$%^&*()*&^%$@}`
4. Maintain XML documentation for all public methods (enforced by `--warnon:3390`)

### Target Frameworks

- **net48**: For Rhino 7 and Rhino 8 (before 8.19)
- **net7.0**: For Rhino 8.19+
- Both frameworks reference RhinoCommon with `PrivateAssets="all" ExcludeAssets="runtime"` (user's Rhino provides it)

### Compiler Warnings

The project enables:
- `--warnon:3390` - Verify XML docstrings completeness
- `--warnon:1182` - Warn on unused variables

### Dependencies

Key packages:
- **RhinoCommon**: Rhino SDK (version differs by target framework)
- **Eto.Forms**: Cross-platform UI (for Mac compatibility)
- **FSharp.Core 6.0.7**: Minimum version for compatibility
- **Ionide.KeepAChangelog.Tasks**: Auto-extract version from CHANGELOG.md
- **Microsoft.SourceLink.GitHub**: Source debugging support

## CI/CD Workflows

- **build.yml**: Builds both projects on Windows with .NET 10 SDK
- **docs.yml**: Generates and deploys documentation to GitHub Pages
- **release-nuget.yml**: Publishes to NuGet
- **outdatedDotnetTool.yml**: Checks for outdated tools

## Common Patterns

### Coercion Functions

Many `CoerceXXXX` functions convert flexible inputs to specific types:
```fsharp
rs.CoercePlane(0, 80, 0)  // Creates XY plane at point
rs.CoerceLayer(layerName)  // Gets layer by name
rs.CoerceRhinoObject(guid) // Gets RhinoObject from GUID
```

### Error Handling

Custom exceptions via `RhinoScriptingException`:
```fsharp
RhinoScriptingException.Raise "Error message %s" value
```

### State Access

- `State.Doc` - Current active RhinoDoc
- `State.Ot` - Object table of current document
- `State.EscapePressed` - Check if user pressed Escape
- `State.CommandSerialNumbers` - Track objects created by last command
